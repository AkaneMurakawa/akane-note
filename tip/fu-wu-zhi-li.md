# 服务治理

## 导致服务不稳定性三大因素

* 慢SQL
* 第三方框架应用的变动，如：SpringBoot的升级
* 代码缺陷，如：不符合业务逻辑，存在多次操作DB的情况，前后端数据库校验不一致，修改的代码影响原有的逻辑（不向下兼容）

## 解决思路

1. 针对以上问题已排查原因，分配到相应的负责人，并落地实施。
2. 定期清理生产错误日志、慢SQL问题。
3. 针对开发常见问题，进行整理和沉淀，并分享解决思路，以此提升开发者的代码质量。整理一套开发流程。
4. 提高智能化监控，及时告警，发现问题。

## 一个规范的服务

* 第一要有**监控记录**，便于分析
* 第二是规范开发流程，首先是开发者自身的提高\(可以通过整理常见问题并分享避免很多坏味道的代码或设计\)，其次对于开发和测试环节，制定相应的规范，通过工具避免线上的超时
* 第三是问题定期处理\(慢SQL、错误日志）  
* 第四是问题总结分享，避免问题 

## 服务日志

由于开发的不规范，有时候可能什么日志都进行打印。当流量大的时候，如果文件或者base64这些字段打印出来，很容易将服务搞垮。

**建议：**

* 流量高峰期，将日志调整为error级别
* 无关的日志不要打印
* 内容过长的无用信息不建议打印，或者需要进行截取
* 适当的进行日志截取

**建议：**

* 错误信息最好和定位到哪一块系统，意味着错误码是唯一的。实际上有些人喜欢用同一个错误码，这样定位问题的时候很不方面。
* 对于比较重要业务，需将日志存储到mongo中，便于后续问题排查，另外还至少需要一个msgId和一个refNo作为索引，方便搜索。

  一些开发人员喜欢什么日志都用log4j2，但是当流量高峰期时，是会进行日志级别调整的，因此不可取，而且不方便查询。

* DDD中台架构，核心业务和非核心业务拆分，服务编排。

## 消息重复消费、幂等设计

* 消息id进行数据库缓存，定时清理或设置过期时间，例如：mongoDB、MySQL、Redis
* 业务幂等，下单前校验，发送mq后再进行校验，防止mq重试失败不回滚。如果有并发问题，需加分布式锁
* 另外，使用mq，需要注意重试保证错误回滚一致性。如客户下单，扣减库存，需要做幂等。或放在mq消费创建单时，保证和创单在一个事务。

